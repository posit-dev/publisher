name: Release
on:
  push:
    tags:
      - "v*.*.*"
jobs:
  build:
    uses: ./.github/workflows/build.yaml
  package:
    needs:
      - build
    uses: ./.github/workflows/package.yaml
  archive:
    needs:
      - build
    uses: ./.github/workflows/archive.yaml
  upload:
    needs:
      - archive
      - package
    uses: ./.github/workflows/upload.yaml
    secrets: inherit
  release:
    runs-on: ubuntu-latest
    needs:
      - archive
      - package
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: extractions/setup-just@v3
      - uses: actions/download-artifact@v7
        with:
          name: archives
          path: archives
      - uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist
      - id: get-prerelease
        run: echo "prerelease=$(just pre-release)" >> "$GITHUB_OUTPUT"
      - uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ steps.get-prerelease.outputs.prerelease == 'true' }}
          files: |
            archives/**/*
            dist/**/*
  notify-slack:
    runs-on: ubuntu-latest
    needs:
      - release
    if: success()
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_RELEASE_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Posit Publisher ${{ github.ref_name }} Released",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "A new version of Posit Publisher has been released."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Changelog"
                      },
                      "url": "https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"
                    }
                  ]
                }
              ]
            }
