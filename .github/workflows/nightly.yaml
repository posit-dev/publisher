name: Nightly
on:
  schedule:
    - cron: "0 06 * * *"
  workflow_dispatch:
jobs:
  agent:
    uses: ./.github/workflows/agent.yaml
  build:
    uses: ./.github/workflows/build.yaml
  package:
    needs: build
    uses: ./.github/workflows/package.yaml
  e2e:
    needs: [package]
    uses: ./.github/workflows/e2e.yaml
    secrets: inherit

  # Extensions
  vscode:
    uses: ./.github/workflows/vscode.yaml

  # Slack notification on failure
  slack-notification:
    needs: [agent, build, package, e2e, vscode]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack of nightly test failure
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: ":warning: Nightly tests failed"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: ":warning: *Nightly Tests Failed*\n\n*Repository:* ${{ github.repository }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
