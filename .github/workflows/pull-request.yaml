name: Pull Request
on:
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  # Detect if any code files changed (to skip CI for docs-only PRs)
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # has-code is true if ANY non-doc file changed
      has-code: ${{ steps.check.outputs.has-code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # Enable file list output for comparison
          list-files: json
          # Detect docs-only changes
          # Note: paths-filter doesn't support negation patterns correctly
          # (each pattern is evaluated independently with some() logic)
          # So we detect docs explicitly and check if ONLY docs changed
          filters: |
            docs:
              - '**/*.md'
              - 'LICENSE'
              - '.gitignore'
              - '.gitattributes'
            all:
              - '**'
      - name: Check for code changes
        id: check
        run: |
          # has-code is true if any file changed that wasn't matched by docs filter
          # i.e., if 'all' matched but the changed files aren't all docs
          if [[ "${{ steps.filter.outputs.all }}" == "true" && "${{ steps.filter.outputs.docs }}" == "true" ]]; then
            # Both matched - check if docs_files equals all_files
            docs_files='${{ steps.filter.outputs.docs_files }}'
            all_files='${{ steps.filter.outputs.all_files }}'
            if [[ "$docs_files" == "$all_files" ]]; then
              echo "has-code=false" >> $GITHUB_OUTPUT
              echo "Only documentation files changed"
            else
              echo "has-code=true" >> $GITHUB_OUTPUT
              echo "Code files changed (not just docs)"
            fi
          elif [[ "${{ steps.filter.outputs.all }}" == "true" ]]; then
            echo "has-code=true" >> $GITHUB_OUTPUT
            echo "Code files changed (no docs)"
          else
            echo "has-code=false" >> $GITHUB_OUTPUT
            echo "No files changed"
          fi

  # Linting and formatting - always runs
  lint:
    uses: ./.github/workflows/lint.yaml

  # Unit Tests - skip if no code changes
  home-view-unit-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/home-view-unit-test.yaml

  agent:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/agent.yaml

  vscode:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/vscode.yaml

  # Build - skip if no code changes
  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/build.yaml

  package:
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/package.yaml

  archive:
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/archive.yaml

  # E2E Tests - skip if no code changes
  e2e:
    needs: [detect-changes, home-view-unit-tests, agent, vscode, package]
    if: |
      always() &&
      needs.detect-changes.outputs.has-code == 'true' &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    uses: ./.github/workflows/e2e.yaml
    secrets: inherit

  upload:
    needs: [detect-changes, archive, package]
    if: |
      always() &&
      github.actor != 'dependabot[bot]' &&
      needs.detect-changes.outputs.has-code == 'true' &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    uses: ./.github/workflows/upload.yaml
    secrets: inherit

  # License generation - skip if no code changes
  generate-licenses:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/generate-licenses.yaml
    with:
      pr_changes: false # No PRs on PRs, infinite loop
      fail_on_forbidden: true
    secrets: inherit
