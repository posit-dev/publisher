name: Pull Request
on:
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  # Detect if any code files changed (to skip CI for docs-only PRs)
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # has-code is true if ANY non-doc file changed
      has-code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # Detect code changes - if none, we can skip tests
          # Using negated patterns: match anything NOT in the docs list
          filters: |
            code:
              - '**'
              - '!**/*.md'
              - '!LICENSE'
              - '!.gitignore'
              - '!.gitattributes'

  # Linting and formatting - always runs
  lint:
    uses: ./.github/workflows/lint.yaml

  # Unit Tests - skip if no code changes
  home-view-unit-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/home-view-unit-test.yaml

  agent:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/agent.yaml

  vscode:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/vscode.yaml

  # Build - skip if no code changes
  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/build.yaml

  package:
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/package.yaml

  archive:
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/archive.yaml

  # E2E Tests - skip if no code changes
  e2e:
    needs: [detect-changes, home-view-unit-tests, agent, vscode, package]
    if: |
      always() &&
      needs.detect-changes.outputs.has-code == 'true' &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    uses: ./.github/workflows/e2e.yaml
    secrets:
      CONNECT_LICENSE: ${{ secrets.CONNECT_LICENSE }}
      CONNECT_LICENSE_FILE: ${{ secrets.CONNECT_LICENSE_FILE }}
      WORKBENCH_LICENSE: ${{ secrets.WORKBENCH_LICENSE }}
      GH_DOWNLOAD_TOKEN: ${{ secrets.GH_DOWNLOAD_TOKEN }}
      PCC_USER_CCQA3: ${{ secrets.PCC_USER_CCQA3 }}

  # Upload PR artifacts to S3 for testing
  # Security: Only runs for non-fork PRs (fork PRs don't have secret access anyway)
  upload:
    needs: [detect-changes, archive, package]
    if: |
      always() &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.actor != 'dependabot[bot]' &&
      needs.detect-changes.outputs.has-code == 'true' &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    uses: ./.github/workflows/upload.yaml
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}

  # License generation - skip if no code changes
  # Note: pr_changes=false means no secrets are needed (no PR will be created)
  generate-licenses:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code == 'true'
    uses: ./.github/workflows/generate-licenses.yaml
    with:
      pr_changes: false # No PRs on PRs, infinite loop
      fail_on_forbidden: true
