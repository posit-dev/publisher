package deployment

// Copyright (C) 2023 by Posit Software, PBC.

import (
	"fmt"
	"io"
	"strings"
	"time"

	"github.com/pelletier/go-toml/v2"
	"github.com/posit-dev/publisher/internal/accounts"
	"github.com/posit-dev/publisher/internal/config"
	"github.com/posit-dev/publisher/internal/inspect/dependencies/renv"
	"github.com/posit-dev/publisher/internal/project"
	"github.com/posit-dev/publisher/internal/schema"
	"github.com/posit-dev/publisher/internal/types"
	"github.com/posit-dev/publisher/internal/util"
)

type Deployment struct {
	// Predeployment and full deployment fields
	Schema        string              `toml:"$schema" json:"$schema"`
	ServerType    accounts.ServerType `toml:"server_type" json:"serverType"`
	ServerURL     string              `toml:"server_url" json:"serverUrl"`
	ClientVersion string              `toml:"client_version" json:"-"`
	CreatedAt     string              `toml:"created_at" json:"createdAt"`
	Type          config.ContentType  `toml:"type" json:"type"`
	ConfigName    string              `toml:"configuration_name" json:"configurationName"`
	ID            types.ContentID     `toml:"id,omitempty" json:"id"`
	DashboardURL  string              `toml:"dashboard_url,omitempty" json:"dashboardUrl"`
	DirectURL     string              `toml:"direct_url,omitempty" json:"directUrl"`
	LogsURL       string              `toml:"logs_url,omitempty" json:"logsUrl"`

	// Full deployment fields
	DeployedAt    string            `toml:"deployed_at,omitempty" json:"deployedAt"`
	BundleID      types.BundleID    `toml:"bundle_id,omitempty" json:"bundleId"`
	BundleURL     string            `toml:"bundle_url,omitempty" json:"bundleUrl"`
	Error         *types.AgentError `toml:"deployment_error,omitempty" json:"deploymentError"`
	Files         []string          `toml:"files,multiline,omitempty" json:"files"`
	Requirements  []string          `toml:"requirements,multiline,omitempty" json:"requirements"`
	Configuration *config.Config    `toml:"configuration,omitempty" json:"configuration"`
	Renv          *renv.Lockfile    `toml:"renv,omitempty" json:"renv"`
}

func New() *Deployment {
	return &Deployment{
		Schema:        schema.DeploymentSchemaURL,
		ServerType:    accounts.ServerTypeConnect,
		ClientVersion: project.Version,
		Type:          config.ContentTypeUnknown,
		CreatedAt:     time.Now().Format(time.RFC3339),
	}
}

func GetDeploymentsPath(base util.AbsolutePath) util.AbsolutePath {
	return base.Join(".posit", "publish", "deployments")
}

func GetDeploymentPath(base util.AbsolutePath, name string) util.AbsolutePath {
	return GetDeploymentsPath(base).Join(name + ".toml")
}

func ListDeploymentFiles(base util.AbsolutePath) ([]util.AbsolutePath, error) {
	dir := GetDeploymentsPath(base)
	return dir.Glob("*.toml")
}

func UntitledDeploymentName(base util.AbsolutePath) (string, error) {
	for i := 1; ; i++ {
		name := fmt.Sprintf("Untitled-%d", i)
		exists, err := GetDeploymentPath(base, name).Exists()
		if err != nil {
			return "", err
		}
		if !exists {
			return name, nil
		}
	}
}

func SaveNameFromPath(path util.AbsolutePath) string {
	return strings.TrimSuffix(path.Base(), ".toml")
}

func RenameDeployment(base util.AbsolutePath, oldName, newName string) error {
	err := util.ValidateFilename(newName)
	if err != nil {
		return err
	}
	oldPath := GetDeploymentPath(base, oldName)
	newPath := GetDeploymentPath(base, newName)
	return oldPath.Rename(newPath.Path)
}

func FromFile(path util.AbsolutePath) (*Deployment, error) {
	err := ValidateFile(path)
	if err != nil {
		return nil, err
	}
	d := New()

	err = util.ReadTOMLFile(path, d)
	if err != nil {
		return nil, err
	}

	// Migration
	if d.LogsURL == "" && d.ID != "" {
		d.LogsURL = util.GetLogsURL(d.ServerURL, d.ID)
	}
	return d, nil
}

func ValidateFile(path util.AbsolutePath) error {
	validator, err := schema.NewValidator[Deployment](schema.DeploymentSchemaURL)
	if err != nil {
		return err
	}
	return validator.ValidateTOMLFile(path)
}

const autogenHeader = "# This file is automatically generated by Posit Publisher; do not edit.\n"

func (d *Deployment) Write(w io.Writer) error {
	_, err := w.Write([]byte(autogenHeader))
	if err != nil {
		return err
	}
	enc := toml.NewEncoder(w)
	return enc.Encode(d)
}

func (d *Deployment) WriteFile(path util.AbsolutePath) error {
	err := path.Dir().MkdirAll(0777)
	if err != nil {
		return err
	}
	f, err := path.Create()
	if err != nil {
		return err
	}
	defer f.Close()
	err = d.Write(f)
	if err != nil {
		return err
	}
	return nil
}
