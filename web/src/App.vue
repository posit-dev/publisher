<!-- Copyright (C) 2023 by Posit Software, PBC. -->

<template>
  <q-layout
    view="hHh lpR fFf"
  >
    <q-header
      elevated
    >
      <q-toolbar class="max-width-md q-pa-auto">
        <AppMenu />
        <WhitePositLogo
          width="70px"
          height="30px"
          :fill="colorStore.activePallete.logo.fill"
          :stroke="colorStore.activePallete.logo.stroke"
          alt="Posit PBC Logo"
        />
        <q-toolbar-title class="q-pl-xs">
          Publisher
        </q-toolbar-title>
      </q-toolbar>
    </q-header>

    <q-page-container>
      <ConfigurePublish
        v-if="currentView === 'configure'"
        @publish="onPublish"
      />
      <PublishProcess
        v-if="currentView === 'publish'"
        :events="allEvents"
        :event-stream="eventStream"
        @back="onConfigure"
      />
    </q-page-container>
  </q-layout>
</template>

<script setup lang="ts">

import { onBeforeUnmount, ref } from 'vue';
import { useQuasar } from 'quasar';

import AppMenu from 'src/components/AppMenu.vue';
import ConfigurePublish from 'src/components/configurePublish/ConfigurePublish.vue';
import PublishProcess from 'src/components/publishProcess/PublishProcess.vue';
import WhitePositLogo from 'src/components/icons/WhitePositLogo.vue';

import { useApi } from 'src/api';
import { useDeploymentStore } from 'src/stores/deployment';
import { useColorStore } from './stores/color';

import { EventStream } from 'src/api/resources/EventStream';
import {
  EventStreamMessage,
  isPublishStart,
  isPublishSuccess,
  getLocalId,
} from 'src/api/types/events';

type viewType = 'configure' | 'publish';

const currentView = ref<viewType>('configure');
const api = useApi();
const deploymentStore = useDeploymentStore();
const colorStore = useColorStore();

const $q = useQuasar();
$q.dark.set('auto');

const eventStream = new EventStream();
// Temporary storage of events
const allEvents = ref<EventStreamMessage[]>([]);

const onPublish = () => {
  currentView.value = 'publish';
};
const onConfigure = () => {
  currentView.value = 'configure';
};

const getInitialDeploymentState = async() => {
  const { data: deployment } = await api.deployment.get();
  deploymentStore.deployment = deployment;
};

let currentPublishStreamID: string = '';

const incomingEvent = (msg: EventStreamMessage) => {
  // We are going to filter these events based on current job id (localId)
  // specific to any publish process. (i.e. Don't display old stream messages which
  // happen to come in which were part of the last publish cycle started.)
  const newId = getLocalId(msg);

  // publish/start event establishes the publishing job id
  if (isPublishStart(msg)) {
    if (newId) {
      currentPublishStreamID = newId;
    }
  } else if (isPublishSuccess(msg)) {
    currentPublishStreamID = '';
  }
  // if we have a publishing job id
  if (currentPublishStreamID && newId !== currentPublishStreamID) {
    return;
  }
  allEvents.value.push(msg);
};
eventStream.addEventMonitorCallback('*', incomingEvent);

eventStream.setDebugMode(true);
eventStream.open('/api/events?stream=messages');
console.log(eventStream.status());

// Have to be sure to close connection or it will be leaked on agent (if it continues to run)
onBeforeUnmount(() => {
  eventStream.close();
});

getInitialDeploymentState();
</script>
