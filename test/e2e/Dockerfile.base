# Defines an image that has the basis for Connect or a User
# Includes Python, R and Quarto versions needed for e2e testing.
#
# - Python: 3.11, 3.12
# - R: 4.3, 4.4
# - Quarto: 1.6, 1.7

FROM ubuntu:24.04 AS base

ARG DEBIAN_FRONTEND=noninteractive
ARG OS_IDENTIFIER=ubuntu-2204

# Configure apt-get mirror and install prerequisites in single layer
RUN sed -i "s/archive.ubuntu.com/us-east-1.ec2.archive.ubuntu.com/g" /etc/apt/sources.list && \
    export TZ=America/New_York && \
    apt-get update && \
    apt-get install -y \
    build-essential \
    curl \
    dnsutils \
    dpkg-sig \
    gawk \
    gfortran \
    git \
    ldap-utils \
    libbz2-dev \
    libcurl4-openssl-dev \
    libdeflate-dev \
    libev-dev \
    libffi-dev \
    liblzma-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libopenblas-dev \
    libpaper-utils \
    libpcre2-dev \
    libreadline-dev \
    libsodium-dev \
    libsqlite3-dev \
    libssl-dev \
    libtinfo5 \
    libxml2-dev \
    libzmq3-dev \
    llvm \
    mailcap \
    make \
    media-types \
    python3-openssl \
    rrdtool \
    software-properties-common \
    sssd-ldap \
    sudo \
    tk-dev \
    unzip \
    vim \
    wget \
    xz-utils \
    zip \
    zlib1g-dev && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

#
# Install Python versions in parallel
#

FROM base AS python-3.11.11
ARG PYTHON_VERSION=3.11.11
RUN curl -fsSL -O https://cdn.rstudio.com/python/${OS_IDENTIFIER}/pkgs/python-${PYTHON_VERSION}_1_amd64.deb \
    && export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -f -y ./python-${PYTHON_VERSION}_1_amd64.deb \
    && rm python-${PYTHON_VERSION}_1_amd64.deb \
    && /opt/python/${PYTHON_VERSION}/bin/pip install --no-cache-dir --upgrade pip setuptools wheel \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

FROM base AS python-3.12.9
ARG PYTHON_VERSION=3.12.9
RUN curl -fsSL -O https://cdn.rstudio.com/python/${OS_IDENTIFIER}/pkgs/python-${PYTHON_VERSION}_1_amd64.deb \
    && export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -f -y ./python-${PYTHON_VERSION}_1_amd64.deb \
    && rm python-${PYTHON_VERSION}_1_amd64.deb \
    && /opt/python/${PYTHON_VERSION}/bin/pip install --no-cache-dir --upgrade pip setuptools wheel \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

#
# Install R versions in parallel
#

FROM base AS r-4.3.3
ARG R_VERSION=4.3.3
RUN curl -O https://cdn.rstudio.com/r/${OS_IDENTIFIER}/pkgs/r-${R_VERSION}_1_amd64.deb \
    && apt-get install -y ./r-${R_VERSION}_1_amd64.deb \
    && rm ./r-${R_VERSION}_1_amd64.deb \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

FROM base AS r-4.4.2
ARG R_VERSION=4.4.2
RUN curl -O https://cdn.rstudio.com/r/${OS_IDENTIFIER}/pkgs/r-${R_VERSION}_1_amd64.deb \
    && apt-get install -y ./r-${R_VERSION}_1_amd64.deb \
    && rm ./r-${R_VERSION}_1_amd64.deb \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

#
# Install Quarto versions in parallel
#

FROM base AS quarto-1.6.42
ENV QUARTO_VERSION=1.6.42
ARG GH_DOWNLOAD_TOKEN
RUN mkdir -p /opt/quarto/${QUARTO_VERSION} \
    && curl -H "Authorization: token ${GH_DOWNLOAD_TOKEN}" -fSL -o quarto.tar.gz \
    "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz" \
    && file quarto.tar.gz | grep 'gzip compressed data' \
    && tar -zxvf quarto.tar.gz -C "/opt/quarto/${QUARTO_VERSION}" --strip-components=1 \
    && rm quarto.tar.gz

FROM base AS quarto-1.7.6
ENV QUARTO_VERSION=1.7.6
ARG GH_DOWNLOAD_TOKEN
RUN mkdir -p /opt/quarto/${QUARTO_VERSION} \
    && curl -H "Authorization: token ${GH_DOWNLOAD_TOKEN}" -fSL -o quarto.tar.gz \
    "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.tar.gz" \
    && file quarto.tar.gz | grep 'gzip compressed data' \
    && tar -zxvf quarto.tar.gz -C "/opt/quarto/${QUARTO_VERSION}" --strip-components=1 \
    && rm quarto.tar.gz

FROM base AS final-stage

# Copy in our installed Python versions
COPY --from=python-3.11.11 /opt/python/3.11.11 /opt/python/3.11.11
COPY --from=python-3.12.9 /opt/python/3.12.9 /opt/python/3.12.9

# Copy in our installed R versions
COPY --from=r-4.3.3 /opt/R/4.3.3 /opt/R/4.3.3
COPY --from=r-4.4.2 /opt/R/4.4.2 /opt/R/4.4.2

# Copy in our installed Quarto versions
COPY --from=quarto-1.6.42 /opt/quarto/1.6.42 /opt/quarto/1.6.42
COPY --from=quarto-1.7.6 /opt/quarto/1.7.6 /opt/quarto/1.7.6

# Create symlinks for default versions
RUN ln -s /opt/python/3.11.11/bin/python /usr/local/bin/python3 \
    && ln -s /opt/R/4.4.2/bin/R /usr/local/bin/R \
    && ln -s /opt/R/4.4.2/bin/Rscript /usr/local/bin/Rscript \
    && ln -s /opt/quarto/1.6.42/bin/quarto /usr/bin/quarto
