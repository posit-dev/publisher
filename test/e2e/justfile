# Build and run all tests against in development
default: dev

# Install Cypress dependencies using npm
install:
    npm install

# Build the specified docker image using docker compose
build service:
    docker build -f Dockerfile.base --tag e2ebase --platform linux/amd64 .
    docker compose build "{{service}}"

start service:
    docker compose up -d "{{service}}"

# Stop all services using docker compose
stop:
    docker compose down --volumes --remove-orphans

lint:
    npm run lint

clear-credentials:
    #!/usr/bin/env bash
    set -euo pipefail

    cat <<EOF > e2e-test.connect-credentials
    # File updated and managed by e2e tests. Refrain from updating it manually.

    EOF

dev: 
    #!/usr/bin/env bash
    set -euo pipefail
    
    # check to see if rsconnect-python is available, because if it is not, then the tests fail in weird ways....
    rsconnect version || {
        echo "rsconnect-python is not installed. Did you forget to start your virtual environment in which it is installed?"
        exit 1
    }
    just build-publisher
    just e2e

e2e:
    #!/usr/bin/env bash
    set -euo pipefail

    function cleanup() {
        just clear-credentials
    }
    trap cleanup EXIT

    just clear-credentials
    just install
    just start "connect-publisher-e2e"
    just start "code-server"
    just start-workbench "release"

    # Install the Publisher extension
    VSIX_FILENAME=$(ls -Art ../../dist | grep linux-amd64 | tail -n 1)
    docker compose exec code-server code-server --install-extension "/home/coder/vsix/${VSIX_FILENAME}"
    just install-workbench-extension "release"

    npm run cypress:open

# This will build all of the images, but you can also force a rebuild for one of them
# using the command `docker compose build --no-cache <service-name>` where <service-name> is 
# listed in the docker-compose.yml file ( code-server & connect-publisher-e2e)
# NOTE: `docker compose` will build an image if it is needed and will use the cache, so no real reason to normally do this.`
build-images:
    docker build -f Dockerfile.base --tag e2ebase --platform linux/amd64 .
    just build "connect-publisher-e2e"
    just build "code-server"
    just pull-workbench "release"

build-publisher:
    USE_PLATFORM="linux/amd64" just ../../build
    USE_PLATFORM="linux/amd64" just ../../package

old-dev:
    #!/usr/bin/env bash
    set -euo pipefail

    function cleanup() {
        just clear-credentials
    }
    trap cleanup EXIT

    USE_PLATFORM="linux/amd64" just ../../build
    USE_PLATFORM="linux/amd64" just ../../package
    just clear-credentials
    just install
    just build "connect-publisher-e2e"
    just build "code-server"
    just start "connect-publisher-e2e"
    just start "code-server"
    npm run cypress:open


# =====================================================================
# Workbench-specific commands
# These commands use the Workbench services defined in docker-compose.yml
# The Workbench images include the default user: rstudio/rstudio 
# as documented here: https://hub.docker.com/r/rstudio/rstudio-workbench
# =====================================================================

# Pull the Workbench container image
pull-workbench service="release":
    docker compose pull workbench-{{ service }}

# Start a Workbench container
start-workbench service="release":
    ../scripts/start-workbench.sh "{{ service }}"

# Stop a Workbench container
stop-workbench service="release":
    docker compose stop workbench-{{ service }}

# Remove Workbench containers
remove-workbench service="release":
    #!/usr/bin/env bash
    set -euo pipefail

    # First stop the container
    just stop-workbench "{{ service }}"

    # Remove the container
    docker compose rm -f workbench-{{ service }}

# Install Publisher extension in a running Workbench container
install-workbench-extension service="release":
    ../scripts/install-workbench-extension.sh "{{ service }}"

# Check if publisher extension is installed in workbench-release
# This command is designed to work from any directory (Cypress or command line)
check-extension:
    ../scripts/check-workbench-extension.sh

# Extract Positron logs from Workbench container
extract-positron-logs service="release":
    ../scripts/extract-positron-logs.sh "{{ service }}"
